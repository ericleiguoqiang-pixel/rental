<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.rental.saas.basedata.mapper.StoreMapper">

    <!-- 根据租户ID查询门店列表 -->
    <select id="findByTenantId" resultType="com.rental.saas.basedata.entity.Store">
        SELECT * FROM store 
        WHERE tenant_id = #{tenantId} AND deleted = 0
        ORDER BY created_time DESC
    </select>

    <!-- 根据城市查询门店列表 -->
    <select id="findByCity" resultType="com.rental.saas.basedata.entity.Store">
        SELECT * FROM store 
        WHERE city = #{city} AND tenant_id = #{tenantId} AND deleted = 0
        ORDER BY created_time DESC
    </select>

    <!-- 查询在线门店列表 -->
    <select id="findOnlineStores" resultType="com.rental.saas.basedata.entity.Store">
        SELECT * FROM store 
        WHERE tenant_id = #{tenantId} AND audit_status = 1 AND online_status = 1 AND deleted = 0
        ORDER BY created_time DESC
    </select>

    <!-- 查询指定范围内的门店 -->
    <select id="findStoresInRange" resultType="com.rental.saas.basedata.entity.Store">
        SELECT * FROM store 
        WHERE audit_status = 1 AND online_status = 1 AND deleted = 0
        AND (
            6371 * acos(
                cos(radians(#{latitude})) * cos(radians(latitude)) * 
                cos(radians(longitude) - radians(#{longitude})) + 
                sin(radians(#{latitude})) * sin(radians(latitude))
            )
        ) &lt;= #{radius}
        ORDER BY (
            6371 * acos(
                cos(radians(#{latitude})) * cos(radians(latitude)) * 
                cos(radians(longitude) - radians(#{longitude})) + 
                sin(radians(#{latitude})) * sin(radians(latitude))
            )
        )
    </select>

    <!-- 统计租户门店数量 -->
    <select id="countByTenantId" resultType="int">
        SELECT COUNT(*) FROM store 
        WHERE tenant_id = #{tenantId} AND deleted = 0
    </select>

    <!-- 检查门店名称是否重复 -->
    <select id="checkStoreNameExists" resultType="int">
        SELECT COUNT(*) FROM store 
        WHERE store_name = #{storeName} AND tenant_id = #{tenantId} AND deleted = 0
        <if test="excludeId != null">
            AND id != #{excludeId}
        </if>
    </select>

</mapper>